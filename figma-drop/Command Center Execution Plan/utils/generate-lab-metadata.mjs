import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, '..');

const navicuesPath = path.join(projectRoot, 'src/app/data/lab/labNavicues.ts');
const metadataPath = path.join(projectRoot, 'src/app/data/lab/labMetadata.ts');

const source = fs.readFileSync(navicuesPath, 'utf8');
const matches = source.match(/\bnavicue_type_id\s*:\s*['"`]/g) ?? [];
const total = matches.length;

if (total === 0) {
  throw new Error(`Unable to derive LAB_SPECIMEN_TOTAL from ${navicuesPath}`);
}

const output = `// Generated by utils/generate-lab-metadata.mjs\n// Do not edit manually.\nexport const LAB_SPECIMEN_TOTAL = ${total};\n`;

const existing = fs.existsSync(metadataPath) ? fs.readFileSync(metadataPath, 'utf8') : '';
if (existing !== output) {
  fs.writeFileSync(metadataPath, output, 'utf8');
  console.log(`Updated lab metadata: LAB_SPECIMEN_TOTAL=${total}`);
} else {
  console.log(`Lab metadata already up to date: LAB_SPECIMEN_TOTAL=${total}`);
}
