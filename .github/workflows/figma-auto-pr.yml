name: Figma Auto PR

on:
  push:
    branches:
      - "figma-drop/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Open or reuse PR to main
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.ref.replace("refs/heads/", "");
            const base = "main";
            const headScope = `${owner}:${branch}`;

            const { data: existing } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head: headScope,
              base,
              per_page: 1
            });

            if (existing.length > 0) {
              core.notice(`PR already exists: ${existing[0].html_url}`);
              return;
            }

            const title = `Figma import: ${branch}`;
            const body = [
              "Automated PR opened from a Figma drop branch.",
              "",
              "## Checklist",
              "- [ ] Figma Guardrails check is green",
              "- [ ] Preview/build smoke-tested",
              "- [ ] NaviCue mappings still align with `public.v_figma_navicue_type_matrix`"
            ].join("\\n");

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head: branch,
              base,
              body
            });

            core.notice(`Created PR #${pr.number}: ${pr.html_url}`);
